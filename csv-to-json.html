<!DOCTYPE html>

<!--
 * csv-to-json: A utility that converts data format from CSV to JSON.
 * Copyright (C) 2009-2012 Christopher Parker <http://www.cparker15.com/>
 * 
 * csv-to-json is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * csv-to-json is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with csv-to-json.  If not, see <http://www.gnu.org/licenses/>.
-->

<html lang="en">
	<head>
		<meta charset="utf-8" />
		
		<title>CSV to JSON</title>
		
		<style>
			.error { font-weight: bold; color: #F00; }
		</style>
		
		<script src="json/json2.js"> </script>
		
		<script>
			var csvRows = []; var objArr = [];
			var benchmarkStart, benchmarkParseEnd, benchmarkObjEnd, benchmarkJsonEnd, benchmarkPopulateEnd;
			
			function setMessage (message, error)
			{
				document.getElementById("message").innerHTML = '<p>' + message + '</p>';
				
				if (error)
					document.getElementById("message").className = "error";
				else
					document.getElementById("message").className = "";
			}
			
			function parseCSVLine (line)
			{

				line = line.split(',');
				
				// check for splits performed inside quoted strings and correct if needed
				for (var i = 0; i < line.length; i++)
				{
					
					var chunk = line[i].replace(/^[\s]*|[\s]*$/g, "");
					var quote = "";
					if (chunk.charAt(0) == '"' || chunk.charAt(0) == "'") quote = chunk.charAt(0);
					if (quote != "" && chunk.charAt(chunk.length - 1) == quote) quote = "";
					
					if (quote != "")
					{
						var j = i + 1;
						
						if (j < line.length) chunk = line[j].replace(/^[\s]*|[\s]*$/g, "");
						
						while (j < line.length && chunk.charAt(chunk.length - 1) != quote)
						{
							line[i] += ',' + line[j];
							line.splice(j, 1);
							chunk = line[j].replace(/[\s]*$/g, "");
						}
						
						if (j < line.length)
						{
							line[i] += ',' + line[j];
							line.splice(j, 1);
						}
					}

					if( line[i].indexOf("'\"") === 0 &&
						line[i].indexOf("\"'") === line[i].length - 2 ) {
						line[i] = convertStringToArray( line[i] ); 
					}

				}
				
				for (var i = 0; i < line.length; i++)
				{
					if( typeof line[i] === "string" ) {
						// remove leading/trailing whitespace
						line[i] = line[i].replace(/^[\s]*|[\s]*$/g, "");
						
						// remove leading/trailing quotes
						if (line[i].charAt(0) == '"') line[i] = line[i].replace(/^"|"$/g, "");
						else if (line[i].charAt(0) == "'") line[i] = line[i].replace(/^'|'$/g, "");
					}
					
				}
				
				return line;
			}

			// Within csv it may be better for the content editor to use carriage returns or newlines to
			// separate what should be comma-delimited lists for readability. This method searches for those
			// characters within quoted blocks of content and replaces them with commas then wraps the whole
			// list in quotes to keep it together.
			function convertToStringArray(csvText) {
				var exp = /"(?:[^\\"]+|\\.)*"/g;
				var matches = csvText.match(exp);
				if(matches) {
					var original;
					var modified;
					for(var i = 0; i < matches.length; i++){
						original = matches[i];
						// surround in quotes to keep array together
						modified = "'" + original.replace(/[\r\n]/g, '", "') + "'";
						csvText = csvText.replace(original, modified);
					}
				}
				return csvText;
			}

			// Final conversion from double-quoted string to array.
			function convertStringToArray(string) {
				var array;
				var i = 0;
				string = string.substring(2,string.length-2);
				array = string.split('", "');
				while(i < array.length){
					if(array[i].length) i++;
					else array.splice(i,1);
				}
				return array;
			}
			
			function csvToJson ()
			{
				var message = "";
				var error = false;
				var f = document.forms["convertForm"];
				var csvText = f.elements["csv"].value;
				var jsonText = "";
				
				setMessage(message, error);
				
				if (csvText == "") { error = true; message = "Enter CSV text below."; }
				
				if (!error)
				{
					csvText = convertToStringArray(csvText);
					benchmarkStart = new Date();
					csvRows = csvText.split(/[\r\n]/g); // split into rows
					
					// get rid of empty rows
					for (var i = 0; i < csvRows.length; i++)
					{
						if (csvRows[i].replace(/^[\s]*|[\s]*$/g, '') == "")
						{
							csvRows.splice(i, 1);
							i--;
						}
					}
					
					if (csvRows.length < 2) { error = true; message = "The CSV text MUST have a header row!"; }
					else
					{
						objArr = [];
						
						for (var i = 0; i < csvRows.length; i++)
						{
							csvRows[i] = parseCSVLine(csvRows[i]);
						}
						
						benchmarkParseEnd = new Date();
						
						for (var i = 1; i < csvRows.length; i++)
						{
							if (csvRows[i].length > 0) objArr.push({});
							
							for (var j = 0; j < csvRows[i].length; j++)
							{
								objArr[i - 1][csvRows[0][j]] = csvRows[i][j];
							}
						}
						
						benchmarkObjEnd = new Date();
						
						jsonText = JSON.stringify(objArr, null, "\t");
						
						benchmarkJsonEnd = new Date();
						
						f.elements["json"].value = jsonText;
						
						benchmarkPopulateEnd = new Date();
						
						message = getBenchmarkResults();
					}
				}
				
				setMessage(message, error);
			}
			
			function getBenchmarkResults ()
			{
				var message = "";
				var totalTime = benchmarkPopulateEnd.getTime() - benchmarkStart.getTime();
				
				var timeDiff = (benchmarkParseEnd.getTime() - benchmarkStart.getTime()); var mostTime = "parsing CSV text";
				if ((benchmarkObjEnd.getTime() - benchmarkParseEnd.getTime()) > timeDiff) { timeDiff = (benchmarkObjEnd.getTime() - benchmarkParseEnd.getTime()); mostTime = "converting to objects"; }
				if ((benchmarkJsonEnd.getTime() - benchmarkObjEnd.getTime()) > timeDiff) { timeDiff = (benchmarkJsonEnd.getTime() - benchmarkObjEnd.getTime()); mostTime = "building JSON text"; }
				if ((benchmarkPopulateEnd.getTime() - benchmarkJsonEnd.getTime()) > timeDiff) { timeDiff = (benchmarkPopulateEnd.getTime() - benchmarkJsonEnd.getTime()); mostTime = "populating JSON text"; }
				
				message += csvRows.length + " CSV line" + (csvRows.length > 1 ? 's' : "") + " converted into " + objArr.length + " object" + (objArr.length > 1 ? 's' : "") + " in " + (totalTime / 1000) + " seconds, with an average of " + ((totalTime / 1000) / csvRows.length) + " seconds per object. Most of the time was spent on " + mostTime + ", which took " + (timeDiff / 1000) + " seconds.";
				
				return message;
			}
		</script>
	</head>
	<body>
		<p>Notes:</p>
		
		<ul>
			<li>The <acronym title="comma-separated values">CSV</acronym> text <strong style="text-transform: uppercase; ">must</strong> have a header row.</li>
			<li>This utility does not currently check for escaped quotes inside of like quotes (e.g.: <code>"foo, \"bar\" baz"</code>).</li>
		</ul>
		
		<hr noshade="noshade" />
		
		<div id="message"><p></p></div>
		
		<form id="convertForm" name="convertForm" onsubmit="return false; ">
			<label for="csv"><acronym title="comma-separated values">CSV</acronym>:</label><br /><textarea id="csv" name="csv" rows="10" cols="60"></textarea><br /><br />
			
			<label for="json"><acronym title="JavaScript Object Notation">JSON</acronym>:</label><br /><textarea id="json" name="json" rows="10" cols="60" readonly="readonly"></textarea><br /><br />
			
			<input type="button" value="Convert" onclick="csvToJson(); " /> <input type="reset" />
		</form>
	</body>
</html>